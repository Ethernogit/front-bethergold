<div class="mx-auto max-w-screen-2xl h-[calc(100vh-50px)] flex flex-col overflow-hidden">
    <!-- Main Content -->
    <div class="flex flex-col gap-4 h-full">
        <!-- Products Table -->
        <div
            class="rounded-2xl border border-[#E8D9A0] bg-[#FFF8E7] shadow-theme-sm dark:border-[#4A474D] dark:bg-[#232126] flex flex-col h-full">
            <!-- Consolidated Header & Search -->
            <div class="border-b border-[#E8D9A0] px-4 py-3 dark:border-[#4A474D] sm:px-6 shrink-0">
                <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                    <!-- Title & Search Group -->
                    <div class="flex flex-1 flex-col gap-4 sm:flex-row sm:items-center">
                        <h1
                            class="font-instrument text-title-md font-semibold text-[#191817] dark:text-white whitespace-nowrap">
                            Inventario
                        </h1>

                        <!-- Action Buttons -->
                        <div class="flex items-center gap-2">
                            <button (click)="startTour()" type="button"
                                class="flex items-center gap-2 rounded-xl border border-[#E8D9A0] bg-white px-4 py-2.5 font-instrument text-sm font-semibold text-[#191817] shadow-theme-sm transition-all hover:bg-[#FBF0C9] dark:border-[#4A474D] dark:bg-[#3a383d] dark:text-white dark:hover:bg-white/5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                Tutorial
                            </button>
                            <button id="tour-inventory-summary" (click)="openSummary()" type="button"
                                class="flex items-center gap-2 rounded-xl border border-[#E8D9A0] bg-white px-4 py-2.5 font-instrument text-sm font-semibold text-[#191817] shadow-theme-sm transition-all hover:bg-[#FBF0C9] dark:border-[#4A474D] dark:bg-[#3a383d] dark:text-white dark:hover:bg-white/5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                                </svg>
                                Resumen
                            </button>
                            <button id="tour-inventory-filter" (click)="openFilters()" type="button"
                                class="flex items-center gap-2 rounded-xl border border-[#E8D9A0] bg-white px-4 py-2.5 font-instrument text-sm font-semibold text-[#191817] shadow-theme-sm transition-all hover:bg-[#FBF0C9] dark:border-[#4A474D] dark:bg-[#3a383d] dark:text-white dark:hover:bg-white/5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                </svg>
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <div class="w-full sm:max-w-md mt-4 sm:mt-0 flex flex-col sm:flex-row gap-3 items-center">
                        <!-- Scanner Mode Toggle -->
                        <div id="tour-inventory-scanner-toggle" class="flex items-center gap-2 cursor-pointer"
                            (click)="toggleScanMode()">
                            <div class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-[#C69214] focus:ring-offset-2"
                                [ngClass]="scanMode() ? 'bg-[#C69214]' : 'bg-[#E8D9A0] dark:bg-[#4A474D]'">
                                <span class="sr-only">Modo Escáner</span>
                                <span aria-hidden="true"
                                    class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                    [ngClass]="scanMode() ? 'translate-x-5' : 'translate-x-0'"></span>
                            </div>
                            <span
                                class="font-instrument text-theme-sm font-medium text-[#46424A] dark:text-gray-300 select-none">Escáner</span>
                        </div>

                        <!-- Search Bar -->
                        <form id="tour-inventory-search" [formGroup]="searchForm" (ngSubmit)="onSearch()"
                            class="w-full flex-1">
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                    @if(scanMode()) {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="text-[#C69214]">
                                        <path d="M3 7V5a2 2 0 0 1 2-2h2" />
                                        <path d="M17 3h2a2 2 0 0 1 2 2v2" />
                                        <path d="M21 17v2a2 2 0 0 1-2 2h-2" />
                                        <path d="M7 21H5a2 2 0 0 1-2-2v-2" />
                                        <rect x="7" y="7" width="10" height="10" rx="1" />
                                    </svg>
                                    } @else {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    }
                                </span>
                                <input type="text" formControlName="search"
                                    [placeholder]="scanMode() ? 'Escanea código para revisar...' : 'Buscar por código, nombre...'"
                                    class="w-full rounded-xl border border-[#E8D9A0] bg-white pl-11 pr-5 py-2.5 font-instrument text-base text-[#191817] placeholder-[#6B6560] outline-none transition-all focus:border-[#C69214] focus:ring-2 focus:ring-[#C69214]/20 dark:border-[#4A474D] dark:bg-[#3a383d] dark:text-white dark:placeholder-gray-600 dark:focus:border-[#FAC600]" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="flex-1 overflow-y-auto p-0 z-0">
                @if (loading()) {
                <div class="flex justify-center py-10">
                    <div
                        class="h-12 w-12 animate-spin rounded-full border-4 border-solid border-[#C69214] border-t-transparent">
                    </div>
                </div>
                } @else if (products().length === 0) {
                <div class="py-10 text-center text-gray-500 dark:text-gray-400">
                    No se encontraron productos en inventario
                </div>
                } @else {
                <div class="relative" id="tour-inventory-table">
                    <table class="w-full table-auto">
                        <thead class="sticky top-0 z-10 bg-[#FBF0C9] dark:bg-[#232126] shadow-sm">
                            <tr class="text-left">
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A]">
                                    Código</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A]">
                                    Nombre</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A]">
                                    Cat / Subcat</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A] text-center">
                                    Stock</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A] text-right">
                                    Peso</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A] text-right">
                                    Precio</th>
                                <th
                                    class="px-4 py-3 font-instrument text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A] text-center">
                                    Revisado</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[#E8D9A0] bg-white dark:divide-[#3D3420] dark:bg-[#3a383d]">
                            @for (product of products(); track product._id) {
                            <tr class="transition-colors hover:bg-[#FBF0C9]/40 dark:hover:bg-[#252017]">
                                <td class="px-4 py-3">
                                    <span
                                        class="font-instrument text-theme-sm font-medium text-[#191817] dark:text-white">{{
                                        product.barcode }}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <p
                                            class="font-instrument text-theme-sm text-[#46424A] dark:text-gray-300 font-medium">
                                            {{ product.name }}</p>
                                        @if(product.reservation) {
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full bg-[#FBF0C9] px-2.5 py-0.5 text-theme-xs font-medium text-[#9A6F0A] dark:bg-[#3D3420] dark:text-[#E8C97A]">
                                            <span class="size-1.5 rounded-full bg-[#C69214]"></span>
                                            Apartado ({{ product.reservation.folio }})
                                        </span>
                                        }
                                    </div>
                                    @if(product.description) {
                                    <p
                                        class="font-instrument text-theme-xs text-[#6B6560] dark:text-gray-400 truncate max-w-[200px]">
                                        {{
                                        product.description }}</p>
                                    }
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-col gap-1 items-start">
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full bg-[#FBF0C9] px-2.5 py-0.5 text-theme-xs font-medium text-[#9A6F0A] dark:bg-[#3D3420] dark:text-[#E8C97A]">
                                            {{ getCategoryName(product) }}
                                        </span>
                                        @if(product.subcategory) {
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full border border-[#E8D9A0] bg-transparent px-2.5 py-0.5 text-theme-xs font-medium text-[#46424A] dark:border-[#4A474D] dark:text-gray-300">
                                            {{ getSubcategoryName(product) }}
                                        </span>
                                        }
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span
                                        class="inline-flex items-center justify-center rounded-full px-2.5 py-0.5 text-theme-xs font-medium"
                                        [ngClass]="{
                                            'bg-success-50 text-success-700 dark:bg-success-500/15 dark:text-success-400': product.stock > 5,
                                            'bg-[#FBF0C9] text-[#9A6F0A] dark:bg-[#3D3420] dark:text-[#E8C97A]': product.stock <= 5 && product.stock > 0,
                                            'bg-error-50 text-error-700 dark:bg-error-500/15 dark:text-error-400': product.stock === 0
                                        }">
                                        {{ product.stock }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="font-instrument text-theme-sm text-[#46424A] dark:text-gray-300">{{
                                        product.specifications?.weight
                                        }}g</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span
                                        class="font-mono text-theme-sm font-medium text-success-700 dark:text-success-400">{{
                                        product.price |
                                        currency }}</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" [checked]="!!product.lastInventoryRevision"
                                            (change)="toggleReview(product, $event)" class="sr-only peer">
                                        <div
                                            class="relative w-11 h-6 bg-[#E8D9A0] peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-success-500/20 dark:peer-focus:ring-success-500/20 rounded-full peer dark:bg-[#4A474D] peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-success-500 dark:peer-checked:bg-success-500">
                                        </div>
                                    </label>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
                }
            </div>

            <!-- Pagination Controls -->
            <div
                class="border-t border-[#E8D9A0] px-4 py-3 dark:border-[#4A474D] sm:px-6 shrink-0 bg-[#FFF8E7] dark:bg-[#232126] rounded-b-2xl">
                <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between font-instrument">
                    <div class="flex items-center gap-2">
                        <p class="text-theme-sm font-medium text-[#46424A] dark:text-gray-300">Items por página:</p>
                        <select [ngModel]="itemsPerPage()" (ngModelChange)="onLimitChange($event)"
                            class="rounded-xl border border-[#E8D9A0] bg-white px-2 py-1 outline-none dark:border-[#4A474D] dark:bg-[#3a383d] dark:text-white transition focus:border-[#C69214] active:border-[#C69214]">
                            <option [value]="10" class="dark:bg-[#3a383d] dark:text-white">10</option>
                            <option [value]="25" class="dark:bg-[#3a383d] dark:text-white">25</option>
                            <option [value]="50" class="dark:bg-[#3a383d] dark:text-white">50</option>
                            <option [value]="100" class="dark:bg-[#3a383d] dark:text-white">100</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-4">
                        <p class="text-theme-sm font-medium text-[#46424A] dark:text-gray-300">
                            Página {{ currentPage() }} de {{ totalPages() }} <span class="font-bold text-[#C69214]">({{
                                totalItems() }} items)</span>
                        </p>
                        <div class="flex items-center gap-2">
                            <button (click)="onPageChange(currentPage() - 1)" [disabled]="currentPage() === 1"
                                class="flex items-center justify-center rounded-xl p-2 text-[#46424A] hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M12.7071 5.29289C13.0976 5.68342 13.0976 6.31658 12.7071 6.70711L9.41421 10L12.7071 13.2929C13.0976 13.6834 13.0976 14.3166 12.7071 14.7071C12.3166 15.0976 11.6834 15.0976 11.2929 14.7071L7.29289 10.7071C6.90237 10.3166 6.90237 9.68342 7.29289 9.29289L11.2929 5.29289C11.6834 4.90237 12.3166 4.90237 12.7071 5.29289Z" />
                                </svg>
                            </button>
                            <button (click)="onPageChange(currentPage() + 1)"
                                [disabled]="products().length < itemsPerPage()"
                                class="flex items-center justify-center rounded-xl p-2 text-[#46424A] hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M7.29289 14.7071C6.90237 14.3166 6.90237 13.6834 7.29289 13.2929L10.5858 10L7.29289 6.70711C6.90237 6.31658 6.90237 5.68342 7.29289 5.29289C7.68342 4.90237 8.31658 4.90237 8.70711 5.29289L12.7071 9.29289C13.0976 9.68342 13.0976 10.3166 12.7071 10.7071L8.70711 14.7071C8.31658 15.0976 7.68342 15.0976 7.29289 14.7071Z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters Sidebar -->
<app-filter-sidebar [isOpen]="showFilters()" [filters]="filterConfig()" (close)="closeFilters()"
    (apply)="applyFilters($event)"></app-filter-sidebar>

<!-- Summary Modal -->
<app-inventory-summary-modal [isOpen]="showSummaryModal()" [filters]="summaryFilters()" (close)="closeSummary()">
</app-inventory-summary-modal>