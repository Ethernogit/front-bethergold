<!-- Providers CRUD Component -->
<div class="mx-auto max-w-screen-2xl h-[calc(100vh-135px)] flex flex-col overflow-hidden">

  <!-- Main Content -->
  <div class="flex flex-col gap-4 h-full">
    <!-- Providers Table -->
    <div
      class="rounded-sm border border-stroke bg-white shadow-default dark:border-gray-800 dark:bg-gray-900 flex flex-col h-full">
      <!-- Header -->
      <div class="border-b border-stroke px-4 py-3 dark:border-gray-800 sm:px-6 shrink-0">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <h3 class="font-medium text-black dark:text-white">
            Listado de Proveedores
          </h3>
          <button type="button"
            class="inline-flex items-center justify-center gap-2 rounded-lg bg-brand-500 px-5 py-2.5 text-center font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500/50 transition-all duration-200"
            (click)="openCreateModal()">
            <i class="fas fa-plus"></i>
            <span>Nuevo Proveedor</span>
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="border-b border-stroke px-4 py-3 dark:border-gray-800 shrink-0">
        <form [formGroup]="searchForm" class="flex flex-col gap-4 sm:flex-row sm:items-end">
          <div class="flex-1">
            <label class="mb-2.5 block text-sm font-medium text-black dark:text-white">
              Buscar
            </label>
            <input type="text"
              class="w-full rounded-lg border border-gray-300 bg-gray-50 px-5 py-2.5 font-medium outline-none transition focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="search" placeholder="Buscar por nombre o código...">
          </div>

          <div class="w-full sm:w-48">
            <label class="mb-2.5 block text-sm font-medium text-black dark:text-white">
              Estado
            </label>
            <select
              class="w-full rounded-lg border border-gray-300 bg-gray-50 px-5 py-2.5 font-medium outline-none transition focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="status">
              <option value="">Todos</option>
              <option value="active">Activo</option>
              <option value="inactive">Inactivo</option>
              <option value="blocked">Bloqueado</option>
            </select>
          </div>

          <div class="w-full sm:w-48">
            <label class="mb-2.5 block text-sm font-medium text-black dark:text-white">
              Tipo
            </label>
            <select
              class="w-full rounded-lg border border-gray-300 bg-gray-50 px-5 py-2.5 font-medium outline-none transition focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="providerTypeId">
              <option value="">Todos</option>
              @for (type of providerTypes(); track type._id || type.id) {
              <option [value]="type._id || type.id">{{ type.name }}</option>
              }
            </select>
          </div>

          <div class="flex gap-2">
            <button type="button"
              class="inline-flex items-center justify-center rounded-lg bg-brand-500 px-5 py-2.5 text-center font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500/50 transition-all"
              (click)="onSearch()">
              Buscar
            </button>
            <button type="button"
              class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-center font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 transition-all"
              (click)="resetFilters()" title="Limpiar filtros">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </form>
      </div>

      <!-- Loading State -->
      @if (loading()) {
      <div class="flex justify-center py-10">
        <div class="h-12 w-12 animate-spin rounded-full border-4 border-solid border-primary border-t-transparent">
        </div>
      </div>
      }

      <!-- Providers Table -->
      @if (!loading()) {
      <div class="flex-1 overflow-y-auto p-0 z-0">
        @if (providers().length > 0) {
        <div class="relative">
          <table class="w-full text-left text-sm text-gray-500 dark:text-gray-400">
            <thead
              class="sticky top-0 z-10 bg-gray-50 text-xs uppercase text-gray-700 dark:bg-gray-800 dark:text-gray-400 shadow-sm">
              <tr>
                <th class="px-6 py-4 font-medium">Código</th>
                <th class="px-6 py-4 font-medium">Nombre</th>
                <th class="px-6 py-4 font-medium">Tipo</th>
                <th class="px-6 py-4 font-medium">Margen</th>
                <th class="px-6 py-4 font-medium">Contacto</th>
                <th class="px-6 py-4 font-medium">Estado</th>
                <th class="px-6 py-4 text-center font-medium">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
              @for (provider of paginatedProviders(); track provider.id) {
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                  {{ provider.code }}
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="font-medium text-gray-900 dark:text-white">{{ provider.name }}</span>
                    @if (provider.tax?.businessName) {
                    <span class="text-xs text-gray-500">{{ provider.tax?.businessName }}</span>
                    }
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span
                    class="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">
                    {{ provider.providerTypeName }}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <span
                    class="inline-flex items-center rounded-full bg-success-50 px-2.5 py-0.5 text-xs font-medium text-success-700 dark:bg-success-900/30 dark:text-success-300">
                    {{ provider.profitMargin }}%
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col gap-1 text-xs">
                    @if (provider.contact?.name) {
                    <div class="flex items-center gap-1.5">
                      <i class="fas fa-user text-gray-400"></i>
                      <span>{{ provider.contact?.name }}</span>
                    </div>
                    }
                    @if (provider.contact?.phone) {
                    <div class="flex items-center gap-1.5">
                      <i class="fas fa-phone text-gray-400"></i>
                      <span>{{ provider.contact?.phone }}</span>
                    </div>
                    }
                    @if (provider.contact?.email) {
                    <div class="flex items-center gap-1.5">
                      <i class="fas fa-envelope text-gray-400"></i>
                      <span>{{ provider.contact?.email }}</span>
                    </div>
                    }
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium" [ngClass]="{
                            'bg-success-50 text-success-700 dark:bg-success-900/30 dark:text-success-300': provider.status === 'active',
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300': provider.status === 'inactive',
                            'bg-error-50 text-error-700 dark:bg-error-900/30 dark:text-error-300': provider.status === 'blocked'
                          }">
                    {{ provider.statusDisplay }}
                  </span>
                </td>
                <td class="px-6 py-4 text-center">
                  <div class="flex items-center justify-center gap-2">
                    <button type="button"
                      class="rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-brand-600 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-brand-400 transition-colors"
                      (click)="openPriceModal(provider)" title="Gestionar Precios">
                      <i class="fas fa-dollar-sign"></i>
                    </button>
                    <button type="button"
                      class="rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-blue-600 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-blue-400 transition-colors"
                      (click)="openEditModal(provider)" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button type="button"
                      class="rounded-lg p-2 text-gray-500 hover:bg-gray-100 hover:text-error-600 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-error-400 transition-colors"
                      (click)="openDeleteModal(provider)" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        } @else {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <div class="mb-4 rounded-full bg-gray-100 p-4 dark:bg-gray-800">
            <i class="fas fa-inbox text-3xl text-gray-400"></i>
          </div>
          <h5 class="mb-2 text-lg font-medium text-gray-900 dark:text-white">No hay proveedores registrados</h5>
          <p class="mb-6 text-sm text-gray-500 dark:text-gray-400">Comienza agregando tu primer proveedor al sistema.
          </p>
          <button type="button"
            class="flex items-center justify-center gap-2 rounded-lg bg-brand-500 px-4 py-2 text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500/50 transition-all"
            (click)="openCreateModal()">
            <i class="fas fa-plus"></i>
            <span>Crear Proveedor</span>
          </button>
        </div>
        }
      </div>

      <!-- Pagination Controls -->
      <div
        class="border-t border-stroke px-4 py-3 dark:border-gray-800 sm:px-6 shrink-0 bg-white dark:bg-gray-900 rounded-b-sm">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex items-center gap-2">
            <p class="text-sm font-medium text-black dark:text-white">Items por página:</p>
            <select [ngModel]="itemsPerPage()" (ngModelChange)="onLimitChange($event)"
              class="rounded border border-stroke bg-transparent px-2 py-1 outline-none dark:border-gray-600 dark:bg-gray-700 dark:text-white transition focus:border-brand-500 active:border-brand-500">
              <option [value]="10" class="dark:bg-gray-700 dark:text-white">10</option>
              <option [value]="25" class="dark:bg-gray-700 dark:text-white">25</option>
              <option [value]="50" class="dark:bg-gray-700 dark:text-white">50</option>
              <option [value]="100" class="dark:bg-gray-700 dark:text-white">100</option>
            </select>
          </div>

          <div class="flex items-center gap-4">
            <p class="text-sm font-medium text-black dark:text-white">
              Página {{ currentPage() }} de {{ totalPages() || 1 }}
            </p>
            <div class="flex items-center gap-2">
              <button (click)="onPageChange(currentPage() - 1)" [disabled]="currentPage() === 1"
                class="flex items-center justify-center rounded p-2 hover:bg-gray-100 dark:hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed transition">
                <svg class="fill-current text-black dark:text-white" width="20" height="20" viewBox="0 0 20 20"
                  fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M12.7071 5.29289C13.0976 5.68342 13.0976 6.31658 12.7071 6.70711L9.41421 10L12.7071 13.2929C13.0976 13.6834 13.0976 14.3166 12.7071 14.7071C12.3166 15.0976 11.6834 15.0976 11.2929 14.7071L7.29289 10.7071C6.90237 10.3166 6.90237 9.68342 7.29289 9.29289L11.2929 5.29289C11.6834 4.90237 12.3166 4.90237 12.7071 5.29289Z" />
                </svg>
              </button>
              <button (click)="onPageChange(currentPage() + 1)" [disabled]="currentPage() >= totalPages()"
                class="flex items-center justify-center rounded p-2 hover:bg-gray-100 dark:hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed transition">
                <svg class="fill-current text-black dark:text-white" width="20" height="20" viewBox="0 0 20 20"
                  fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M7.29289 14.7071C6.90237 14.3166 6.90237 13.6834 7.29289 13.2929L10.5858 10L7.29289 6.70711C6.90237 6.31658 6.90237 5.68342 7.29289 5.29289C7.68342 4.90237 8.31658 4.90237 8.70711 5.29289L12.7071 9.29289C13.0976 9.68342 13.0976 10.3166 12.7071 10.7071L8.70711 14.7071C8.31658 15.0976 7.68342 15.0976 7.29289 14.7071Z" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>

<!-- Provider Form Modal -->
@if (showModal()) {
<div
  class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto overflow-x-hidden bg-black/50 p-4 backdrop-blur-sm transition-all">
  <div
    class="relative w-full max-w-4xl rounded-2xl bg-white shadow-2xl dark:bg-gray-900 ring-1 ring-gray-200 dark:ring-gray-800">
    <!-- Modal Header -->
    <div class="flex items-center justify-between border-b border-gray-200 p-5 dark:border-gray-800">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
        {{ editingProvider() ? 'Editar Proveedor' : 'Nuevo Proveedor' }}
      </h3>
      <button type="button"
        class="ml-auto inline-flex items-center rounded-lg bg-transparent p-1.5 text-sm text-gray-400 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-800 dark:hover:text-white transition-colors"
        (click)="closeModal()">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6 max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar">
      <form [formGroup]="providerForm">
        <!-- Basic Information -->
        <div class="mb-6">
          <h4 class="mb-4 text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Información
            Básica</h4>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Nombre *</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('name')" formControlName="name">
              @if (isFieldInvalid('name')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('name') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Código *</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 uppercase focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('code')" formControlName="code">
              @if (isFieldInvalid('code')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('code') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Tipo de Proveedor *</label>
              <select
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('providerTypeId')" formControlName="providerTypeId">
                <option value="">Seleccionar tipo...</option>
                @for (type of providerTypes(); track type._id || type.id) {
                <option [value]="type._id || type.id">{{ type.name }}</option>
                }
              </select>
              @if (isFieldInvalid('providerTypeId')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('providerTypeId') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Margen de Ganancia (%)
                *</label>
              <input type="number"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('profitMargin')" formControlName="profitMargin" min="0"
                max="100" step="0.1">
              @if (isFieldInvalid('profitMargin')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('profitMargin') }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Payment Terms -->
        <div class="mb-6 border-t border-gray-200 pt-6 dark:border-gray-800">
          <h4 class="mb-4 text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Condiciones
            Comerciales</h4>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Términos de Pago</label>
              <select
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                formControlName="paymentTerms">
                @for (option of paymentTermsOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Días de Crédito</label>
              <input type="number"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                formControlName="creditDays" min="0">
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="mb-6 border-t border-gray-200 pt-6 dark:border-gray-800">
          <h4 class="mb-4 text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Información
            de Contacto</h4>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Nombre de Contacto</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('contactName')" formControlName="contactName">
              @if (isFieldInvalid('contactName')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('contactName') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Email</label>
              <input type="email"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('contactEmail')" formControlName="contactEmail">
              @if (isFieldInvalid('contactEmail')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('contactEmail') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Teléfono</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                formControlName="contactPhone">
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Móvil</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                formControlName="contactMobile">
            </div>
          </div>
        </div>

        <!-- Address -->
        <div class="mb-6 border-t border-gray-200 pt-6 dark:border-gray-800">
          <h4 class="mb-4 text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Dirección
          </h4>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Calle</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                formControlName="street">
            </div>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
              <div>
                <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Ciudad</label>
                <input type="text"
                  class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                  formControlName="city">
              </div>
              <div>
                <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Estado</label>
                <input type="text"
                  class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                  formControlName="state">
              </div>
              <div>
                <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Código Postal</label>
                <input type="text"
                  class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                  formControlName="zipCode">
              </div>
            </div>
          </div>
        </div>

        <!-- Tax Information -->
        <div class="mb-6 border-t border-gray-200 pt-6 dark:border-gray-800">
          <h4 class="mb-4 text-sm font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Información
            Fiscal</h4>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">RFC</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 uppercase focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('rfc')" formControlName="rfc">
              @if (isFieldInvalid('rfc')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('rfc') }}</p>
              }
            </div>
            <div>
              <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Razón Social</label>
              <input type="text"
                class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
                [class.border-error-500]="isFieldInvalid('businessName')" formControlName="businessName">
              @if (isFieldInvalid('businessName')) {
              <p class="mt-1 text-xs text-error-500">{{ getFieldError('businessName') }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="mb-6 border-t border-gray-200 pt-6 dark:border-gray-800">
          <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Notas</label>
          <textarea
            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-brand-500 dark:focus:ring-brand-500"
            [class.border-error-500]="isFieldInvalid('notes')" formControlName="notes" rows="3"></textarea>
          @if (isFieldInvalid('notes')) {
          <p class="mt-1 text-xs text-error-500">{{ getFieldError('notes') }}</p>
          }
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-end gap-3 border-t border-gray-200 p-6 dark:border-gray-800">
      <button type="button"
        class="rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 transition-all"
        (click)="closeModal()">
        Cancelar
      </button>
      <button type="button"
        class="inline-flex items-center justify-center rounded-lg bg-brand-500 px-5 py-2.5 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        [disabled]="loading()" (click)="saveProvider()">
        @if (loading()) {
        <svg class="mr-2 h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        }
        {{ editingProvider() ? 'Actualizar' : 'Crear' }}
      </button>
    </div>
  </div>
</div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal()) {
<div
  class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto overflow-x-hidden bg-black/50 p-4 backdrop-blur-sm transition-all">
  <div
    class="relative w-full max-w-md rounded-2xl bg-white shadow-2xl dark:bg-gray-900 ring-1 ring-gray-200 dark:ring-gray-800">
    <div class="p-6 text-center">
      <div
        class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-error-100 dark:bg-error-900/30">
        <i class="fas fa-exclamation-triangle text-xl text-error-500"></i>
      </div>
      <h3 class="mb-2 text-lg font-semibold text-gray-900 dark:text-white">Confirmar Eliminación</h3>
      <p class="mb-6 text-sm text-gray-500 dark:text-gray-400">
        ¿Estás seguro de que quieres eliminar el proveedor <strong>{{ deletingProvider()?.name }}</strong>?
        <br>
        <span class="text-xs">Esta acción desactivará el proveedor pero mantendrá el historial.</span>
      </p>
      <div class="flex items-center justify-center gap-3">
        <button type="button"
          class="rounded-lg border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 transition-all"
          (click)="closeDeleteModal()">
          Cancelar
        </button>
        <button type="button"
          class="inline-flex items-center justify-center rounded-lg bg-error-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-error-700 focus:outline-none focus:ring-2 focus:ring-error-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          [disabled]="loading()" (click)="confirmDelete()">
          @if (loading()) {
          <svg class="mr-2 h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          }
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
}

<!-- Price Management Modal -->
@if (showPriceModal()) {
<div
  class="fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto overflow-x-hidden bg-black/50 p-4 backdrop-blur-sm transition-all"
  (click)="closePriceModal()">
  <div
    class="relative w-full max-w-4xl rounded-2xl bg-white shadow-2xl ring-1 ring-gray-200 dark:bg-gray-800 dark:ring-gray-700"
    (click)="$event.stopPropagation()">

    <!-- Modal Header -->
    <div class="flex items-center justify-between border-b border-gray-200 p-5 dark:border-gray-700">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
        Precios - {{ pricingProvider()?.name }}
      </h3>
      <button type="button"
        class="ms-auto inline-flex h-8 w-8 items-center justify-center rounded-lg bg-transparent text-sm text-gray-400 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white"
        (click)="closePriceModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-6 max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar">
      <!-- Add Price Form -->
      <div class="mb-6 rounded-xl border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-700/50">
        <h6 class="mb-4 text-sm font-semibold text-gray-900 dark:text-white">Agregar Nuevo Precio</h6>
        <form [formGroup]="priceForm" class="grid grid-cols-1 gap-4 md:grid-cols-12 items-end">
          <div class="md:col-span-3">
            <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Subcategoría</label>
            <select
              class="block w-full rounded-lg border border-gray-300 bg-white p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="subcategoryId">
              <option value="">Opcional (Todas)</option>
              @for (sub of subcategories(); track sub._id) {
              <option [value]="sub._id">{{ sub.name }}</option>
              }
            </select>
          </div>
          <div class="md:col-span-3">
            <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Tipo de Material *</label>
            <select
              class="block w-full rounded-lg border border-gray-300 bg-white p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="materialTypeId">
              <option value="">Seleccione</option>
              @for (type of materialTypes(); track type.id) {
              <option [value]="type.id">{{ type.name }} - {{ type.karat }}k</option>
              }
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Precio/g *</label>
            <div class="relative">
              <div class="pointer-events-none absolute inset-y-0 start-0 flex items-center ps-2">
                <span class="text-gray-500 dark:text-gray-400">$</span>
              </div>
              <input type="number"
                class="block w-full rounded-lg border border-gray-300 bg-white p-2.5 ps-5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:focus:border-brand-500 dark:focus:ring-brand-500"
                placeholder="0.00" formControlName="pricePerGram">
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Margen (%)</label>
            <input type="number"
              class="block w-full rounded-lg border border-gray-300 bg-white p-2.5 text-sm text-gray-900 focus:border-brand-500 focus:ring-brand-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:focus:border-brand-500 dark:focus:ring-brand-500"
              formControlName="profitMargin" min="0" max="100" step="0.1">
          </div>
          <div class="md:col-span-2">
            <button type="button"
              class="flex w-full items-center justify-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-4 focus:ring-brand-300 dark:bg-brand-600 dark:hover:bg-brand-700 dark:focus:ring-brand-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              [disabled]="loading() || priceForm.invalid" (click)="addPrice()">
              <i class="fas fa-plus"></i>
              Agregar Precio
            </button>
          </div>
        </form>

        <!-- Current Prices -->
        <div class="mt-6">
          <h6 class="mb-4 text-sm font-semibold text-gray-900 dark:text-white">Precios Actuales</h6>
          <div class="relative overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
            <table class="w-full text-left text-sm text-gray-500 dark:text-gray-400">
              <thead class="bg-gray-50 text-xs uppercase text-gray-700 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3">Subcategoría</th>
                  <th scope="col" class="px-6 py-3">Material</th>
                  <th scope="col" class="px-6 py-3">Precio Base</th>
                  <th scope="col" class="px-6 py-3">Margen</th>
                  <th scope="col" class="px-6 py-3">Precio Final</th>
                  <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (price of currentProviderPrices(); track price._id || price.id) {
                <tr
                  class="border-b bg-white hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700">
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                    {{ price.subcategoryId?.name || 'Todas' }}
                  </td>
                  <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                    {{ price.materialTypeId.name }} ({{ price.materialTypeId.karat }}k)
                  </td>
                  <td class="px-6 py-4">
                    ${{ price.pricePerGram | number:'1.2-2' }}
                  </td>
                  <td class="px-6 py-4">
                    <span
                      class="inline-flex items-center rounded-full bg-success-50 px-2.5 py-0.5 text-xs font-medium text-success-700 dark:bg-success-900/30 dark:text-success-300">
                      {{ price.profitMargin || 0 }}%
                    </span>
                  </td>
                  <td class="px-6 py-4 font-semibold text-brand-600 dark:text-brand-400">
                    ${{ calculateFinalPrice(price.pricePerGram, price.profitMargin) | number:'1.2-2' }}
                  </td>
                  <td class="px-6 py-4 text-center">
                    <button class="font-medium text-red-600 hover:underline dark:text-red-500"
                      (click)="deletePrice(price._id || price.id)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                } @empty {
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                    No hay precios configurados
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="flex items-center justify-end border-t border-gray-200 p-6 dark:border-gray-700">
      <button type="button"
        class="rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 focus:z-10 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700"
        (click)="closePriceModal()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}