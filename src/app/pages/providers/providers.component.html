<!-- Providers CRUD Component -->
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h3 mb-0">Gestión de Proveedores</h2>
        <button 
          type="button" 
          class="btn btn-primary"
          (click)="openCreateModal()">
          <i class="fas fa-plus me-2"></i>
          Nuevo Proveedor
        </button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-body">
          <form [formGroup]="searchForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Buscar</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="search"
                placeholder="Buscar por nombre o código...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Estado</label>
              <select class="form-select" formControlName="status">
                <option value="">Todos los estados</option>
                <option value="active">Activo</option>
                <option value="inactive">Inactivo</option>
                <option value="blocked">Bloqueado</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Tipo de Proveedor</label>
              <select class="form-select" formControlName="providerTypeId">
                <option value="">Todos los tipos</option>
                @for (type of providerTypes(); track type._id || type.id) {
                  <option [value]="type._id || type.id">{{ type.name }}</option>
                }
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid gap-2">
                <button 
                  type="button" 
                  class="btn btn-outline-primary"
                  (click)="onSearch()">
                  <i class="fas fa-search"></i>
                  Buscar
                </button>
                <button 
                  type="button" 
                  class="btn btn-outline-secondary btn-sm"
                  (click)="resetFilters()">
                  <i class="fas fa-times"></i>
                  Limpiar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="row">
      <div class="col">
        <div class="d-flex justify-content-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Providers Table -->
  @if (!loading()) {
    <div class="row">
      <div class="col">
        <div class="card">
          <div class="card-body">
            @if (providers().length > 0) {
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Código</th>
                      <th>Nombre</th>
                      <th>Tipo</th>
                      <th>Margen (%)</th>
                      <th>Contacto</th>
                      <th>Estado</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (provider of providers(); track provider.id) {
                      <tr>
                        <td>
                          <strong>{{ provider.code }}</strong>
                        </td>
                        <td>
                          <div>
                            <div class="fw-semibold">{{ provider.name }}</div>
                            @if (provider.tax?.businessName) {
                              <small class="text-muted">{{ provider.tax?.businessName }}</small>
                            }
                          </div>
                        </td>
                        <td>
                          <span class="badge bg-info">{{ provider.providerTypeName }}</span>
                        </td>
                        <td>
                          <span class="badge bg-success">{{ provider.profitMargin }}%</span>
                        </td>
                        <td>
                          <div class="small">
                            @if (provider.contact?.name) {
                              <div><i class="fas fa-user me-1"></i>{{ provider.contact?.name }}</div>
                            }
                            @if (provider.contact?.phone) {
                              <div><i class="fas fa-phone me-1"></i>{{ provider.contact?.phone }}</div>
                            }
                            @if (provider.contact?.email) {
                              <div><i class="fas fa-envelope me-1"></i>{{ provider.contact?.email }}</div>
                            }
                          </div>
                        </td>
                        <td>
                          <span [class]="getStatusClass(provider.status)">
                            {{ provider.statusDisplay }}
                          </span>
                        </td>
                        <td class="text-center">
                          <div class="btn-group" role="group">
                            <button 
                              type="button" 
                              class="btn btn-sm btn-outline-primary"
                              (click)="openPriceModal(provider)"
                              title="Gestionar Precios">
                              <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button 
                              type="button" 
                              class="btn btn-sm btn-outline-secondary"
                              (click)="openEditModal(provider)"
                              title="Editar">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button 
                              type="button" 
                              class="btn btn-sm btn-outline-danger"
                              (click)="openDeleteModal(provider)"
                              title="Eliminar">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay proveedores registrados</h5>
                <p class="text-muted">Comienza agregando tu primer proveedor</p>
                <button 
                  type="button" 
                  class="btn btn-primary"
                  (click)="openCreateModal()">
                  <i class="fas fa-plus me-2"></i>
                  Crear Proveedor
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>

<!-- Provider Form Modal -->
@if (showModal()) {
  <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ editingProvider() ? 'Editar Proveedor' : 'Nuevo Proveedor' }}
          </h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="providerForm">
            <!-- Basic Information -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Nombre *</label>
                <input 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('name')"
                  formControlName="name">
                @if (isFieldInvalid('name')) {
                  <div class="invalid-feedback">{{ getFieldError('name') }}</div>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label">Código *</label>
                <input 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('code')"
                  formControlName="code"
                  style="text-transform: uppercase;">
                @if (isFieldInvalid('code')) {
                  <div class="invalid-feedback">{{ getFieldError('code') }}</div>
                }
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Tipo de Proveedor *</label>
                <select 
                  class="form-select"
                  [class.is-invalid]="isFieldInvalid('providerTypeId')"
                  formControlName="providerTypeId">
                  <option value="">Seleccionar tipo...</option>
                  @for (type of providerTypes(); track type._id || type.id) {
                    <option [value]="type._id || type.id">{{ type.name }}</option>
                  }
                </select>
                @if (isFieldInvalid('providerTypeId')) {
                  <div class="invalid-feedback">{{ getFieldError('providerTypeId') }}</div>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label">Margen de Ganancia (%) *</label>
                <input 
                  type="number" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('profitMargin')"
                  formControlName="profitMargin"
                  min="0" max="100" step="0.1">
                @if (isFieldInvalid('profitMargin')) {
                  <div class="invalid-feedback">{{ getFieldError('profitMargin') }}</div>
                }
              </div>
            </div>

            <!-- Payment Terms -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Términos de Pago</label>
                <select class="form-select" formControlName="paymentTerms">
                  @for (option of paymentTermsOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Días de Crédito</label>
                <input 
                  type="number" 
                  class="form-control"
                  formControlName="creditDays"
                  min="0">
              </div>
            </div>

            <!-- Contact Information -->
            <h6 class="mb-3">Información de Contacto</h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Nombre de Contacto</label>
                <input 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('contactName')"
                  formControlName="contactName">
                @if (isFieldInvalid('contactName')) {
                  <div class="invalid-feedback">{{ getFieldError('contactName') }}</div>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input 
                  type="email" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('contactEmail')"
                  formControlName="contactEmail">
                @if (isFieldInvalid('contactEmail')) {
                  <div class="invalid-feedback">{{ getFieldError('contactEmail') }}</div>
                }
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Teléfono</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="contactPhone">
              </div>
              <div class="col-md-6">
                <label class="form-label">Móvil</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="contactMobile">
              </div>
            </div>

            <!-- Address -->
            <h6 class="mb-3">Dirección</h6>
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">Calle</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="street">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Ciudad</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="city">
              </div>
              <div class="col-md-4">
                <label class="form-label">Estado</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="state">
              </div>
              <div class="col-md-4">
                <label class="form-label">Código Postal</label>
                <input 
                  type="text" 
                  class="form-control"
                  formControlName="zipCode">
              </div>
            </div>

            <!-- Tax Information -->
            <h6 class="mb-3">Información Fiscal</h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">RFC</label>
                <input 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('rfc')"
                  formControlName="rfc"
                  style="text-transform: uppercase;">
                @if (isFieldInvalid('rfc')) {
                  <div class="invalid-feedback">{{ getFieldError('rfc') }}</div>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label">Razón Social</label>
                <input 
                  type="text" 
                  class="form-control"
                  [class.is-invalid]="isFieldInvalid('businessName')"
                  formControlName="businessName">
                @if (isFieldInvalid('businessName')) {
                  <div class="invalid-feedback">{{ getFieldError('businessName') }}</div>
                }
              </div>
            </div>

            <!-- Notes -->
            <div class="mb-3">
              <label class="form-label">Notas</label>
              <textarea 
                class="form-control"
                [class.is-invalid]="isFieldInvalid('notes')"
                formControlName="notes"
                rows="3"></textarea>
              @if (isFieldInvalid('notes')) {
                <div class="invalid-feedback">{{ getFieldError('notes') }}</div>
              }
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn btn-primary"
            [disabled]="loading()"
            (click)="saveProvider()">
            @if (loading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            {{ editingProvider() ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal()) {
  <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que quieres eliminar el proveedor <strong>{{ deletingProvider()?.name }}</strong>?</p>
          <p class="text-muted small">Esta acción desactivará el proveedor pero mantendrá el historial.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn btn-danger"
            [disabled]="loading()"
            (click)="confirmDelete()">
            @if (loading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Price Management Modal -->
@if (showPriceModal()) {
  <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Precios - {{ pricingProvider()?.name }}
          </h5>
          <button type="button" class="btn-close" (click)="closePriceModal()"></button>
        </div>
        <div class="modal-body">
          <!-- Add Price Form -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Agregar Nuevo Precio</h6>
            </div>
            <div class="card-body">
              <form [formGroup]="priceForm" class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Tipo de Material *</label>
                  <select 
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('materialTypeId', priceForm)"
                    formControlName="materialTypeId">
                    <option value="">Seleccionar material...</option>
                    @for (material of materialTypes(); track material._id || material.id) {
                      <option [value]="material._id || material.id">
                        {{ material.name }} ({{ material.unit }})
                      </option>
                    }
                  </select>
                  @if (isFieldInvalid('materialTypeId', priceForm)) {
                    <div class="invalid-feedback">{{ getFieldError('materialTypeId', priceForm) }}</div>
                  }
                </div>
                <div class="col-md-3">
                  <label class="form-label">Precio por Gramo *</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input 
                      type="number" 
                      class="form-control"
                      [class.is-invalid]="isFieldInvalid('pricePerGram', priceForm)"
                      formControlName="pricePerGram"
                      min="0.01" step="0.01">
                  </div>
                  @if (isFieldInvalid('pricePerGram', priceForm)) {
                    <div class="invalid-feedback">{{ getFieldError('pricePerGram', priceForm) }}</div>
                  }
                </div>
                <div class="col-md-3">
                  <label class="form-label">Precio Final</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input 
                      type="text" 
                      class="form-control"
                      readonly
                      [value]="calculateFinalPrice(priceForm.get('pricePerGram')?.value || 0) | number:'1.2-2'">
                  </div>
                  <small class="text-muted">Incluye margen del {{ pricingProvider()?.profitMargin }}%</small>
                </div>
                <div class="col-md-2">
                  <label class="form-label">&nbsp;</label>
                  <button 
                    type="button" 
                    class="btn btn-primary d-block w-100"
                    [disabled]="loading() || priceForm.invalid"
                    (click)="addPrice()">
                    @if (loading()) {
                      <span class="spinner-border spinner-border-sm"></span>
                    } @else {
                      <i class="fas fa-plus"></i>
                      Agregar
                    }
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Current Prices -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Precios Actuales</h6>
            </div>
            <div class="card-body">
              @if (currentProviderPrices().length > 0) {
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>Material</th>
                        <th>Precio/Gramo</th>
                        <th>Precio Final</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (price of currentProviderPrices(); track price._id || price.id) {
                        <tr>
                          <td>
                            <span class="badge bg-info">{{ price.materialType?.name }}</span>
                            <small class="text-muted d-block">{{ price.materialType?.unit }}</small>
                          </td>
                          <td>${{ price.pricePerGram | number:'1.2-2' }}</td>
                          <td>
                            <strong>${{ calculateFinalPrice(price.pricePerGram) | number:'1.2-2' }}</strong>
                          </td>
                          <td>
                            <span [class]="getStatusClass(price.status)">
                              {{ price.status === 'active' ? 'Activo' : 'Inactivo' }}
                            </span>
                          </td>
                          <td>
                            <button 
                              type="button" 
                              class="btn btn-sm btn-outline-danger"
                              (click)="deletePrice(price._id || price.id!)"
                              title="Eliminar precio">
                              <i class="fas fa-trash"></i>
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              } @else {
                <div class="text-center py-3">
                  <i class="fas fa-tag fa-2x text-muted mb-2"></i>
                  <p class="text-muted">No hay precios configurados para este proveedor</p>
                </div>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closePriceModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
}
