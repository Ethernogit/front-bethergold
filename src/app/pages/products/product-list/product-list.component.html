<div class="h-[calc(100vh-50px)] flex flex-col overflow-hidden">
    <!-- Main Content -->
    <div class="flex flex-col gap-4 h-full">
        <!-- Products Table -->
        <div
            class="rounded-2xl border border-[#E8D9A0] bg-white shadow-theme-sm dark:border-[#3D3420] dark:bg-[#252017] flex flex-col h-full">
            <!-- Consolidated Header & Search -->
            <div class="border-b border-[#E8D9A0] px-4 py-3 dark:border-[#3D3420] sm:px-6 shrink-0">
                <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                    <!-- Title & Search Group -->
                    <div class="flex flex-1 flex-col gap-4 sm:flex-row sm:items-center">
                        <div>
                            <h1
                                class="font-outfit text-title-sm font-semibold text-[#191817] dark:text-white whitespace-nowrap">
                                Listado de Productos
                            </h1>
                            <p class="mt-1 font-display text-theme-sm text-[#6B6560] dark:text-gray-500">
                                Gestiona tu inventario de joyería
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-2 shrink-0">
                        @if (selectedProducts().size > 0) {
                        <button (click)="bulkPrintLabels()" title="Imprimir Etiquetas Seleccionadas"
                            class="relative flex items-center gap-2 rounded-xl border border-[#C69214] bg-transparent p-2.5 font-outfit text-sm font-semibold text-[#C69214] transition-all hover:bg-[#FBF0C9] dark:hover:bg-[#3D3420]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2">
                                </path>
                                <rect x="6" y="14" width="12" height="8"></rect>
                            </svg>
                            <span
                                class="absolute -top-1.5 -right-1.5 flex h-5 w-5 items-center justify-center rounded-full bg-error-500 text-xs font-bold text-white shadow-sm ring-2 ring-white dark:ring-[#252017] animate-in zoom-in">
                                {{ selectedProducts().size }}
                            </span>
                        </button>
                        }

                        <button (click)="startTour()"
                            class="hidden md:inline-flex items-center gap-2 rounded-xl border border-[#E8D9A0] bg-white px-5 py-2.5 font-outfit text-sm font-medium text-[#46424A] transition-all hover:bg-gray-100 dark:border-[#3D3420] dark:bg-[#1A1714] dark:text-gray-300 dark:hover:bg-white/5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Tutorial
                        </button>

                        <button (click)="openFilters()"
                            class="inline-flex items-center gap-2 rounded-xl border border-[#E8D9A0] bg-white px-5 py-2.5 font-outfit text-sm font-medium text-[#46424A] transition-all hover:bg-gray-100 dark:border-[#3D3420] dark:bg-[#1A1714] dark:text-gray-300 dark:hover:bg-white/5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            Filtrar
                        </button>

                        <button (click)="openCreateModal()" id="btn-new-product"
                            class="flex items-center gap-2 rounded-xl bg-gradient-to-br from-[#C69214] to-[#FAC600] px-5 py-2.5 font-outfit text-sm font-semibold text-[#191817] shadow-theme-sm transition-all hover:from-[#9A6F0A] hover:to-[#C69214] hover:shadow-theme-md active:scale-[0.98]">
                            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 4.5V15.5M4.5 10H15.5" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" />
                            </svg>
                            Nuevo Producto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="flex-1 overflow-auto p-0 z-0">
                @if (loading()) {
                <div class="flex justify-center py-10">
                    <div
                        class="h-12 w-12 animate-spin rounded-full border-4 border-solid border-[#C69214] border-t-transparent">
                    </div>
                </div>
                } @else if (products().length === 0) {
                <div class="py-10 text-center font-display text-[#46424A] dark:text-gray-400">
                    No se encontraron productos
                </div>
                } @else {
                <div class="relative">
                    <table class="w-full table-auto">
                        <thead class="sticky top-0 z-10 bg-[#FBF0C9] dark:bg-[#252017] shadow-sm">
                            <tr
                                class="text-left font-outfit text-theme-xs font-semibold uppercase tracking-wider text-[#9A6F0A] dark:text-[#E8C97A]">
                                <th class="px-4 py-3 w-12 text-center">
                                    <input type="checkbox" [checked]="isAllSelected()"
                                        (change)="toggleAllSelection($event)"
                                        class="h-5 w-5 rounded border-[#E8D9A0] text-[#C69214] focus:ring-[#C69214] bg-white dark:border-[#3D3420] dark:bg-[#1A1714] dark:ring-offset-[#1A1714] cursor-pointer">
                                </th>
                                <th class="px-4 py-3">Código</th>
                                <th class="px-4 py-3">Nombre</th>
                                <th class="px-4 py-3">Cat / Subcat</th>
                                <th class="px-4 py-3">Material</th>
                                <th class="px-4 py-3 text-center">Stock</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-right">Peso</th>
                                <th class="px-4 py-3 text-right">Costo</th>
                                <th class="px-4 py-3 text-right">Precio</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[#E8D9A0] bg-white dark:divide-[#3D3420] dark:bg-[#1A1714]">
                            @for (product of products(); track product._id) {
                            <tr class="transition-colors hover:bg-[#FBF0C9]/40 dark:hover:bg-[#252017]" [ngClass]="{
                                    'bg-[#FBF0C9]/20': isSelected(product._id!),
                                    'dark:bg-[#252017]/50': isSelected(product._id!)
                                }">
                                <td class="px-4 py-3 text-center">
                                    <input type="checkbox" [checked]="isSelected(product._id!)"
                                        (change)="toggleSelection(product._id!)"
                                        class="h-5 w-5 rounded border-[#E8D9A0] text-[#C69214] focus:ring-[#C69214] bg-white dark:border-[#3D3420] dark:bg-[#1A1714] dark:ring-offset-[#1A1714] cursor-pointer">
                                </td>
                                <td class="px-4 py-3">
                                    <span
                                        class="font-display text-theme-sm font-medium text-[#191817] dark:text-white">{{
                                        product.barcode }}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <p class="font-display text-theme-sm font-medium text-[#191817] dark:text-white">{{
                                        product.name }}</p>
                                    @if(product.description) {
                                    <p
                                        class="font-display text-theme-xs text-[#6B6560] dark:text-gray-400 truncate max-w-[200px]">
                                        {{
                                        product.description }}</p>
                                    }
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex flex-col gap-1.5 items-start">
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full bg-[#FBF0C9] px-2.5 py-0.5 text-theme-xs font-medium text-[#9A6F0A] dark:bg-[#3D3420] dark:text-[#E8C97A]">
                                            {{ getCategoryName(product) }}
                                        </span>
                                        @if(product.subcategory) {
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full bg-gray-100 px-2.5 py-0.5 text-theme-xs font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-300">
                                            {{ getSubcategoryName(product) }}
                                        </span>
                                        }
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <div
                                        class="flex flex-col gap-0.5 text-[#46424A] dark:text-gray-300 font-display text-theme-sm">
                                        @if(product.jewelryDetails?.karatage) {
                                        <span class="text-[#191817] dark:text-white font-medium">{{
                                            product.jewelryDetails?.karatage }}</span>
                                        }
                                        @if(product.jewelryDetails?.goldType) {
                                        <span class="text-theme-xs text-[#6B6560] dark:text-gray-400">{{
                                            product.jewelryDetails?.goldType }}</span>
                                        }
                                        @else {
                                        <span class="text-theme-xs text-[#6B6560] dark:text-gray-500">-</span>
                                        }
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span
                                        class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-theme-xs font-medium"
                                        [ngClass]="{
                                            'bg-success-50 text-success-700 dark:bg-success-500/15 dark:text-success-400': product.stock > 5,
                                            'bg-warning-50 text-warning-700 dark:bg-warning-500/15 dark:text-warning-400': product.stock <= 5 && product.stock > 0,
                                            'bg-error-50 text-error-700 dark:bg-error-500/15 dark:text-error-400': product.stock === 0
                                        }">
                                        <span class="size-1.5 rounded-full" [ngClass]="{
                                            'bg-success-500': product.stock > 5,
                                            'bg-warning-500': product.stock <= 5 && product.stock > 0,
                                            'bg-error-500': product.stock === 0
                                        }"></span>
                                        {{ product.stock }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span
                                        class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-theme-xs font-medium"
                                        [ngClass]="{
                                            'bg-success-50 text-success-700 dark:bg-success-500/15 dark:text-success-400': product.status === 'active',
                                            'bg-error-50 text-error-700 dark:bg-error-500/15 dark:text-error-400': product.status !== 'active'
                                        }">
                                        <span class="size-1.5 rounded-full" [ngClass]="{
                                            'bg-success-500': product.status === 'active',
                                            'bg-error-500': product.status !== 'active'
                                        }"></span>
                                        {{ product.status === 'active' ? 'Activo' : 'Inactivo' }}
                                    </span>
                                </td>
                                <td
                                    class="px-4 py-3 text-right font-display text-theme-sm text-[#46424A] dark:text-gray-300">
                                    {{ product.specifications?.weight }}g
                                </td>
                                <td
                                    class="px-4 py-3 text-right font-display text-theme-sm text-[#46424A] dark:text-gray-300">
                                    {{ product.cost | currency }}
                                </td>
                                <td
                                    class="px-4 py-3 text-right font-display text-theme-sm font-semibold text-[#191817] dark:text-white">
                                    {{ product.price | currency }}
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center justify-center gap-2">
                                        <button (click)="openEditModal(product)"
                                            class="text-[#46424A] hover:text-[#C69214] dark:text-gray-400 dark:hover:text-[#FAC600] transition-colors"
                                            title="Editar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2-2h14a2 2 0 0 0 2-2v-7">
                                                </path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                                </path>
                                            </svg>
                                        </button>
                                        <button (click)="openDeleteModal(product)"
                                            class="text-error-500 hover:text-error-700 dark:text-error-400 dark:hover:text-error-300 transition-colors"
                                            title="Eliminar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
                }
            </div>

            <!-- Pagination Controls -->
            <div
                class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between border-t border-[#E8D9A0] px-4 py-3 dark:border-[#3D3420] sm:px-6 shrink-0 bg-white dark:bg-[#252017] rounded-b-2xl">
                <div class="flex items-center gap-2">
                    <p class="font-display text-theme-sm font-medium text-[#46424A] dark:text-gray-300">Items por
                        página:</p>
                    <select [ngModel]="itemsPerPage()" (ngModelChange)="onLimitChange($event)"
                        class="rounded-xl border border-[#E8D9A0] bg-white px-3 py-1.5 font-display text-theme-sm text-[#191817] outline-none dark:border-[#3D3420] dark:bg-[#1A1714] dark:text-white transition-all focus:border-[#C69214] focus:ring-2 focus:ring-[#C69214]/20">
                        <option [value]="10" class="dark:bg-[#1A1714] dark:text-white">10</option>
                        <option [value]="25" class="dark:bg-[#1A1714] dark:text-white">25</option>
                        <option [value]="50" class="dark:bg-[#1A1714] dark:text-white">50</option>
                        <option [value]="100" class="dark:bg-[#1A1714] dark:text-white">100</option>
                    </select>
                </div>

                <div class="flex items-center gap-4">
                    <p class="font-display text-theme-sm font-medium text-[#46424A] dark:text-gray-300">
                        Página {{ currentPage() }} de {{ totalPages() }} <span
                            class="font-semibold text-[#191817] dark:text-white">({{ totalItems() }} items)</span>
                    </p>
                    <div class="flex items-center gap-2">
                        <button (click)="onPageChange(currentPage() - 1)" [disabled]="currentPage() === 1"
                            class="flex items-center justify-center rounded-xl p-2 text-[#46424A] hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M12.7071 5.29289C13.0976 5.68342 13.0976 6.31658 12.7071 6.70711L9.41421 10L12.7071 13.2929C13.0976 13.6834 13.0976 14.3166 12.7071 14.7071C12.3166 15.0976 11.6834 15.0976 11.2929 14.7071L7.29289 10.7071C6.90237 10.3166 6.90237 9.68342 7.29289 9.29289L11.2929 5.29289C11.6834 4.90237 12.3166 4.90237 12.7071 5.29289Z" />
                            </svg>
                        </button>
                        <button (click)="onPageChange(currentPage() + 1)" [disabled]="currentPage() >= totalPages()"
                            class="flex items-center justify-center rounded-xl p-2 text-[#46424A] hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M7.29289 14.7071C6.90237 14.3166 6.90237 13.6834 7.29289 13.2929L10.5858 10L7.29289 6.70711C6.90237 6.31658 6.90237 5.68342 7.29289 5.29289C7.68342 4.90237 8.31658 4.90237 8.70711 5.29289L12.7071 9.29289C13.0976 9.68342 13.0976 10.3166 12.7071 10.7071L8.70711 14.7071C8.31658 15.0976 7.68342 15.0976 7.29289 14.7071Z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Product Form -->
@if (showModal()) {
<div
    class="fixed inset-0 z-999999 flex items-center justify-center bg-[#191817]/60 backdrop-blur-sm p-4 overflow-y-auto">
    <!-- Modal Wrapper -->
    <div
        class="relative w-full max-w-4xl max-h-[90vh] flex flex-col rounded-2xl border border-[#E8D9A0] bg-[#FFFDF7] dark:border-[#3D3420] dark:bg-[#1A1714] shadow-xl overflow-hidden">
        <!-- Close Button -->
        <button (click)="closeModal()"
            class="absolute right-4 top-4 text-[#6B6560] hover:text-[#191817] dark:text-gray-400 dark:hover:text-white z-50 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>

        <!-- Header -->
        <div class="px-8 py-4 border-b border-[#E8D9A0] dark:border-[#3D3420] shrink-0">
            <h3 class="font-outfit text-title-sm font-semibold text-[#191817] dark:text-white">
                {{ editingProduct() ? 'Editar Producto' : 'Nuevo Producto' }}
            </h3>
        </div>

        <!-- Body -->
        <div class="p-8 overflow-y-auto">
            <app-product-form [product]="editingProduct()" [isEditMode]="!!editingProduct()" (close)="closeModal()"
                (saved)="onProductSaved()">
            </app-product-form>
        </div>
    </div>
</div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal()) {
<div
    class="fixed left-0 top-0 z-999999 flex h-full min-h-screen w-full items-center justify-center bg-[#191817]/60 backdrop-blur-sm px-4 py-5">
    <div
        class="w-full max-w-[142.5rem] md:max-w-md rounded-2xl border border-[#E8D9A0] bg-[#FFFDF7] px-8 py-12 text-center shadow-xl dark:border-[#3D3420] dark:bg-[#1A1714] md:px-10 md:py-10">
        <div
            class="mx-auto mb-6 flex size-14 items-center justify-center rounded-full bg-error-50 dark:bg-error-500/15">
            <svg class="size-7 text-error-600 dark:text-error-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <h3 class="font-outfit text-title-sm font-semibold text-[#191817] dark:text-white mb-2">¿Eliminar Producto?</h3>
        <p class="mb-10 font-display text-theme-sm text-[#46424A] dark:text-gray-400">¿Estás seguro de que deseas
            eliminar este
            producto?</p>
        <div class="flex gap-4 justify-center">
            <button (click)="closeDeleteModal()"
                class="flex items-center justify-center gap-2 rounded-xl px-5 py-2.5 font-outfit text-sm font-medium text-[#46424A] transition-all hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/5 sm:w-auto sm:min-w-[120px]">
                Cancelar
            </button>
            <button (click)="confirmDelete()"
                class="flex items-center justify-center gap-2 rounded-xl bg-error-600 px-5 py-2.5 font-outfit text-sm font-semibold text-white shadow-theme-sm transition-all hover:bg-error-700 active:scale-[0.98] sm:w-auto sm:min-w-[120px]">
                Eliminar
            </button>
        </div>
    </div>
</div>
}

<app-filter-sidebar [isOpen]="showFilters()" title="Filtros de Productos" [filters]="filterConfig()"
    (close)="closeFilters()" (apply)="applyFilters($event)" (valueChange)="onFilterChange($event)">
</app-filter-sidebar>